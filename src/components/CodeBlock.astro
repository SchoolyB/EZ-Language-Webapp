---
interface Props {
  code: string;
  title?: string;
  showLineNumbers?: boolean;
}

const { code, title, showLineNumbers = false } = Astro.props;

// Simple EZ syntax highlighter
function highlightEZ(code: string): string {
  const keywords = ['var', 'const', 'do', 'if', 'else', 'for', 'while', 'return', 'import', 'in', 'break', 'continue', 'switch', 'case', 'default', 'struct', 'enum', 'fn', 'pub'];
  const types = ['int', 'float', 'string', 'bool', 'void', 'any', 'char'];
  const builtins = ['println', 'print', 'len', 'append', 'string', 'int', 'float'];

  let result = code;

  // Escape HTML first
  result = result
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Comments (single line // and multi-line /* */)
  result = result.replace(/(\/\/.*$)/gm, '<span class="ez-comment">$1</span>');
  result = result.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="ez-comment">$1</span>');

  // Strings
  result = result.replace(/("(?:[^"\\]|\\.)*")/g, '<span class="ez-string">$1</span>');

  // Numbers
  result = result.replace(/\b(\d+\.?\d*)\b/g, '<span class="ez-number">$1</span>');

  // Keywords
  keywords.forEach(kw => {
    const regex = new RegExp(`\\b(${kw})\\b`, 'g');
    result = result.replace(regex, '<span class="ez-keyword">$1</span>');
  });

  // Types
  types.forEach(t => {
    const regex = new RegExp(`\\b(${t})\\b`, 'g');
    result = result.replace(regex, '<span class="ez-type">$1</span>');
  });

  // Builtins/Functions (simple heuristic: word followed by open paren)
  builtins.forEach(fn => {
    const regex = new RegExp(`\\b(${fn})(?=\\()`, 'g');
    result = result.replace(regex, '<span class="ez-function">$1</span>');
  });

  // Import paths (@std, @math, etc)
  result = result.replace(/(@\w+)/g, '<span class="ez-string">$1</span>');

  return result;
}

const highlightedCode = highlightEZ(code);
const lines = highlightedCode.split('\n');
---

<div class="code-block rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden">
  {title && (
    <div class="px-4 py-2 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 text-sm font-medium opacity-60">
      {title}
    </div>
  )}
  <pre class="!m-0 !rounded-none !border-0 bg-gray-100 dark:bg-gray-900"><code>{showLineNumbers ? (
    lines.map((line, i) => (
      <Fragment>
        <span class="select-none opacity-30 inline-block w-8 text-right mr-4">{i + 1}</span><span set:html={line} />{'\n'}
      </Fragment>
    ))
  ) : (
    <Fragment set:html={highlightedCode} />
  )}</code></pre>
</div>
