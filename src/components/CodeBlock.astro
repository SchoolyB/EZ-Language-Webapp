---
interface Props {
  code: string;
  title?: string;
}

const { code, title } = Astro.props;

// Simple EZ syntax highlighter using marker-based approach to avoid regex conflicts
function highlightEZ(code: string): string {
  const keywords = ['temp', 'const', 'do', 'if', 'or', 'otherwise', 'for', 'for_each', 'as_long_as', 'return', 'import', 'using', 'in', 'break', 'continue', 'struct', 'enum'];
  const types = ['int', 'float', 'string', 'bool', 'void', 'any', 'char', 'map'];
  const builtins = ['println', 'print', 'len', 'append', 'range', 'typeof'];

  let result = code;
  const markers: { marker: string; replacement: string }[] = [];
  let markerIndex = 0;

  // Helper to create unique markers
  const createMarker = (content: string, className: string): string => {
    const marker = `__EZ_MARKER_${markerIndex++}__`;
    const escaped = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    markers.push({ marker, replacement: `<span class="${className}">${escaped}</span>` });
    return marker;
  };

  // Extract multi-line comments first
  result = result.replace(/(\/\*[\s\S]*?\*\/)/g, (match) => createMarker(match, 'ez-comment'));

  // Extract single-line comments
  result = result.replace(/(\/\/.*$)/gm, (match) => createMarker(match, 'ez-comment'));

  // Extract strings
  result = result.replace(/("(?:[^"\\]|\\.)*")/g, (match) => createMarker(match, 'ez-string'));

  // Extract single-char strings
  result = result.replace(/('(?:[^'\\]|\\.)')/g, (match) => createMarker(match, 'ez-string'));

  // Now escape remaining HTML
  result = result
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Import paths (@std, @math, etc)
  result = result.replace(/(@\w+)/g, '<span class="ez-string">$1</span>');

  // Numbers
  result = result.replace(/\b(\d+\.?\d*)\b/g, '<span class="ez-number">$1</span>');

  // Keywords
  keywords.forEach(kw => {
    const regex = new RegExp(`\\b(${kw})\\b`, 'g');
    result = result.replace(regex, '<span class="ez-keyword">$1</span>');
  });

  // Types
  types.forEach(t => {
    const regex = new RegExp(`\\b(${t})\\b`, 'g');
    result = result.replace(regex, '<span class="ez-type">$1</span>');
  });

  // Builtins/Functions
  builtins.forEach(fn => {
    const regex = new RegExp(`\\b(${fn})(?=\\()`, 'g');
    result = result.replace(regex, '<span class="ez-function">$1</span>');
  });

  // Restore all markers
  markers.forEach(({ marker, replacement }) => {
    result = result.replace(marker, replacement);
  });

  return result;
}

const highlightedCode = highlightEZ(code);
---

<div class="code-block overflow-hidden">
  {title && (
    <div class="px-4 py-2 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 text-sm font-medium opacity-60">
      {title}
    </div>
  )}
  <pre class="m-0 p-4 overflow-x-auto bg-gray-100 dark:bg-gray-900 text-sm"><code set:html={highlightedCode} /></pre>
</div>
